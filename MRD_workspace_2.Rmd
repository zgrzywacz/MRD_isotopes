---
title: "MRD_workspace_2"
author: "Zack Grzywacz"
date: "July 15, 2021"
output: html_document
---





```{r}
library(lubridate)
library(lattice)
library(rnaturalearth)
library(rnaturalearthdata)
library(rasterVis)
library(seas)
library(s2dverification)
library(reshape2)
library(dplyr)
library(Hmisc)
library(ggplot2)
library(viridis)
library(ggExtra)
library(grid)
library(pheatmap)
library(treeclim)
library(raster)
library(dplR)
library(scPDSI)
library(tidyr)
library(rworldmap)
library(ggpubr)
```


```{r}
substrRight <- function(x, n){
  substr(x, nchar(x)-n+1, nchar(x))
}
```

```{r}
raw <- read.csv("raw_isotopes.csv") # Raw isotope data
raw$year <- substrRight(raw$sample_ID, 4)
raw$year <- strtoi(raw$year)

annual_summary <- raw %>% group_by(year) %>% summarise(mean = mean(o18corr, na.rm = TRUE)) # Combined Isotope data

tab <- read.csv("tabulated_18o.csv") # Oxygen data tabulated
rownames(tab) <- tab[,1]
tab[,1] <- NULL

tab2 <- read.csv("tabulated_13c.csv") # carbon data tabulated
rownames(tab2) <- tab2[,1]
tab2[,1] <- NULL

gnip <- read.csv("CG_GNIP.csv")
gnip$Date <- parse_date_time(gnip$Date, "mdy")
gnip$month <- month(gnip$Date)
gnip$year <- year(gnip$Date)
for (i in c(1:288)){
if (gnip$month[i] < 9){
  gnip$seas.year[i] = (gnip$year[i] - 1)
}
else{
  gnip$seas.year[i] = gnip$year[i]
}
}

gnip_outlier <- gnip
gnip_outlier$O18[gnip_outlier$O18 > 1] <- NA

vpd <- read.csv("vpd_monthly_1959_2019.csv")
vpd <- vpd[13:720,]

clim <- read.csv("silo_monthly_1959_2019.csv")

prysm <- read.csv("prysm_full.csv")

echam5 <- read.csv("echam5wiso_MRD.csv")
```


```{r}
clim$prysm <- as.numeric(NA)
clim[1:660,]$prysm <- prysm[13:672,]$d18o
clim$echam5 <- as.numeric(NA)
clim[1:660,]$echam5 <- echam5[13:672,]$d18oP
```

```{r}
for (i in 1:732){
  if (clim[i,2]%in% c(1,3,5,7,8,10,12) == TRUE ){
    clim[i,4] <- clim[i,4]*31
  }
  else if (clim[i,2]%in% c(4,6,9,11) == TRUE ){
    clim[i,4] <- clim[i,4]*30
  }
  else{
    clim[i,4] <- clim[i,4]*28
  }
}
```


Visualize 18O series

```{r}
raw$year <- as.factor(raw$year)
ggplot(raw, aes(x=year, y=c13corr)) + 
  geom_boxplot(fill='#E69F00', color='black')
```

```{r}
cors1 <- cor(tab, use="complete.obs")
mean(cors1[cors1!=1])
```


Standardize 18O series

```{r}
std_18o <- scale(tab)
```

Corr matrix

```{r}
cors_O18 <- cor(std_18o, use = "complete.obs")
```

Average interseries correlation:

```{r}
mean(cors_O18[cors_O18 != 1])
```

```{r}
std_13c <- scale(tab2)
cors_C13 <- cor(std_13c, use='complete.obs')
```

```{r}
mean(cors_C13[cors_C13 != 1])
```


The same - duh.

```{r}
sd_vals <- apply(tab, 1, sd, na.rm=T)
mean(sd_vals)
```


```{r}
std_summary <- apply(tab, 1, median, na.rm=T)
std_z_summary <- apply(std_18o, 1, median, na.rm=T)
```

Compare MRD station to SILO

```{r}
MRDprecip <- read.csv("MRD_station_precip.csv")
MRDprecip <- MRDprecip[,3:5]
colnames(MRDprecip)[3] <- "Precip"
MRDtemp <- read.csv("MRD_station_temp.csv")
MRDtemp <- MRDtemp[,3:5]
colnames(MRDtemp)[3] <- "Temp"
MRDrad <- read.csv("MRD_station_rad.csv")
MRDrad <- MRDrad[,3:5]
colnames(MRDrad)[3] <- "Rad"
MRDprecip <- complete(MRDprecip, expand(MRDprecip, Year, Month))
MRDtemp <- complete(MRDtemp, expand(MRDtemp, Year, Month))
MRDrad <- complete(MRDrad, expand(MRDrad, Year, Month))
```

```{r}
plot(MRDprecip[1:276,]$Precip, clim[457:732,]$precip)
plot(MRDtemp[1:288,]$Temp, clim[445:732,]$temp)
plot(MRDrad[1:360,]$Rad, clim[373:732,]$rad)
```





```{r}
Precip_compare <- data.frame(station = MRDprecip[1:276,]$Precip, silo = clim[457:732,]$precip)
Temp_compare <- data.frame(station = MRDtemp[1:288,]$Temp, silo = clim[445:732,]$temp)
Rad_compare <- data.frame(station = MRDrad[1:360,]$Rad, silo = clim[373:732,]$rad)
```

CHANGE PRECIP to mm total or mm/day (figure hour how I did mm/day the first time)
Repeat this plot for temp and rad

```{r}
png(file="tempCompare.png")
ggplot(Temp_compare, aes(station, silo))+
  geom_point(shape=23, color="red")+
  xlab("MRD Station Temperature (°C)")+
  ylab("SILO Temperature (°C)")+
  scale_x_continuous(breaks=seq(0,20,5))+
  scale_y_continuous(breaks=seq(0,20,5))
dev.off()
```




Station data follows closely. BUT is there a significant change pre-199x (whenever station comes in)

rad - 1990
temp - 1996
precip - 1997

```{r}
plot(clim$precip, type="l")
```
 
```{r}
plot(MRDprecip$Precip, type="l")
```
 
 
 Seasonal spread appears to be slighlty higher post-1997. Investigate further:
 
```{r}
plot(subset(clim, month == 2)$year, subset(clim, month == 12)$precip)
```

Some months do appear to have increased spread after 1997. As in, year-to-year changes have more variability, and as a result there also appears to be more intra-year spread when all points are plotted. However, this could also be the result of a slight positive trend, which may or may not have been captured by the pre-1997 version of the model
 
 
```{r}
plot(MRDtemp$Temp, type="l")
```
 Seems fine to me
 
 
```{r}
plot(clim$year, clim$rad)
```
 Looks fine to me.


Climograph from MRD station data:

```{r}
ggdf <- data.frame(Month = MRDtemp$Month )
ggdf$Month <- month.abb
ggdf$Month <- factor(ggdf$Month, levels = month.abb)
ggdf$meanT <- as.numeric(MRDtemp$Temp)
ggdf$prec_mm <- as.numeric(NA)
ggdf[13:312,]$prec_mm <- MRDprecip$Precip

ggdf <- ggdf %>% group_by(Month) %>% summarise(meanT = mean(meanT, na.rm=TRUE), prec_mm = mean(prec_mm, na.rm=TRUE))
```





```{r}
climograph <- ggplot(data = ggdf, mapping = aes(x = Month, y = prec_mm, group = 1)) + 
  geom_bar(stat = "identity", color="#404788FF", fill="#404788FF", width = 0.5) + 
  geom_line(aes(y = meanT*30, group=1), color="#3CBB75FF", size=1.5) + # Scale data to match desired scale
  scale_y_continuous("Precipitation [mm]", 
                     sec.axis = sec_axis(~ . /30, name = "Temperature [°C]") # Reverse transformation to match data
  ) +
   theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
          panel.background = element_blank(), axis.line = element_line(colour = "black"))
```


```{r}
png(file="climograph.png")
climograph
dev.off()
```


Groupings

```{r}
downslope_sites <- subset(std_18o, select=c("X603","X605","X612","X619"))
upslope_sites <- subset(std_18o, select=c("X604","X607","X609","X611"))
cluster_group1 <- subset(std_18o, select=c("X603","X605","X609","X612","X619"))
cluster_group2 <- subset(std_18o, select=c("X604","X606","X607","X617"))
downslope_summary <- data.frame(rowMeans(downslope_sites, na.rm=TRUE))
colnames(downslope_summary) <- "mean"
upslope_summary <- data.frame(rowMeans(upslope_sites, na.rm=TRUE))
colnames(upslope_summary) <- "mean"
group1_summary <- data.frame(rowMeans(cluster_group1, na.rm=TRUE))
colnames(group1_summary) <- "mean"
group2_summary <- data.frame(rowMeans(cluster_group2, na.rm=TRUE))
colnames(group2_summary) <- "mean"
```



Make correlation function that corrs parameter plus lag
Take all factors -> output plot/table


Change this slightly to allow for nextyr corrs as well
```{r}
o18_corrs <- function(df, trees){
  prevclim <- df[1:708,]
  newclim <- df[13:720,]
  nextclim <- df[25:732,]
  output <- data.frame(Clim="", Month="", Corr="", p="")
  for (param in c(3:ncol(df))){
    tempdf0 <- data.frame(Clim=colnames(df[param]), Month=c(11:12), Corr="", p="")
    tempdf <- data.frame(Clim=colnames(df[param]), Month=c(1:12), Corr="", p="")
    tempdf2 <- data.frame(Clim=colnames(df[param]), Month=c(1:5), Corr="", p="")
    for (m in 11:12){
      n = (m-10)
      mon_sub <- subset(prevclim, month == m)
      test <- cor.test(mon_sub[[param]], trees)
      tempdf0$Corr[n] <- test$estimate
      tempdf0$p[n] <- test$p.value
    }
    for (m in 1:12){
      mon_sub <- subset(newclim, month == m)
      test <- cor.test(mon_sub[[param]], trees)
      tempdf$Corr[m] <- test$estimate
      tempdf$p[m] <- test$p.value
    }
    for (m in 1:5){
      mon_sub <- subset(nextclim, month == m)
      test <- cor.test(mon_sub[[param]], trees)
      tempdf2$Corr[m] <- test$estimate
      tempdf2$p[m] <- test$p.value
    }
  output <- rbind(output, tempdf0, tempdf, tempdf2)
  }
  output <- output[-1,]
  output$Corr <- as.numeric(output$Corr)
  output$p <- as.numeric(output$p)
  output$Month <- c("P.Nov","P.Dec","P.Jan","P.Feb","P.Mar","P.Apr","P.May","Jun","Jul","Aug","Sep","Oct","Nov","Dec","Jan","Feb","Mar","Apr","May")
  return(output)
}
```

```{r}
subset(clim, month == 1)
```

```{r}
o18_corrs(clim, annual_summary$mean)
```



Figure out scPDSI

Take this output and add it to clim data frame

```{r}
pdsi_output <- pdsi(clim$precip, clim$pet, start=1959, sc=TRUE)
```



```{r}
clim$pdsi <- pdsi_output$X
```

```{r}
o18_corrs(clim, annual_summary$mean)
```


```{r}
clim_for_oxygen <- clim[,c(-6,-7,-8,-10)]
```


```{r}
newdf <- o18_corrs(clim_for_oxygen, std_summary)
newdf$Month <- factor(newdf$Month, levels=unique(newdf$Month))
gg <- ggplot(newdf, aes(x=Month, y=Clim, fill=Corr)) + geom_tile(color="white", size=0.1) + scale_fill_viridis(name="# Events") + coord_equal() + labs(x=NULL, y=NULL, title="Monthly Correlations")+geom_point(data=newdf[newdf$p<0.05,])
gg
```


Groupings:

```{r}
newdf <- o18_corrs(clim_for_oxygen, downslope_summary$mean)
newdf$Month <- factor(newdf$Month, levels=unique(newdf$Month))
gg <- ggplot(newdf, aes(x=Month, y=Clim, fill=Corr)) + geom_tile(color="white", size=0.1) + scale_fill_viridis(name="# Events") + coord_equal() + labs(x=NULL, y=NULL, title="Downslope Monthly Correlations")+geom_point(data=newdf[newdf$p<0.05,])
gg
```


```{r}
newdf <- o18_corrs(clim_for_oxygen, upslope_summary$mean)
newdf$Month <- factor(newdf$Month, levels=unique(newdf$Month))
gg <- ggplot(newdf, aes(x=Month, y=Clim, fill=Corr)) + geom_tile(color="white", size=0.1) + scale_fill_viridis(name="# Events") + coord_equal() + labs(x=NULL, y=NULL, title="Upslope Monthly Correlations")+geom_point(data=newdf[newdf$p<0.05,])
gg
```

```{r}
plot(clim$pdsi)
```


```{r}
mon_test <- subset(clim, month==12)
plot(mon_test[2:60,]$pdsi, std_summary)
```


Individual Trees:

```{r}
newdf <- o18_corrs(clim_for_oxygen, std_18o[,10])
newdf$Month <- factor(newdf$Month, levels=unique(newdf$Month))
gg <- ggplot(newdf, aes(x=Month, y=Clim, fill=Corr)) + geom_tile(color="white", size=0.1) + scale_fill_viridis(name="# Events") + coord_equal() + labs(x=NULL, y=NULL, title="619")+geom_point(data=newdf[newdf$p<0.05,])
gg
```

```{r}
std_18o
```

```{r}
DJF <- subset(clim, month == 12 | month == 1 | month == 2)
DJF$seasyear <- ifelse(DJF$month>=12, DJF$year, (DJF$year-1))
DJF_gnip <- group_by(DJF, seasyear) %>% summarise(mean=mean(gnip, na.rm=TRUE))
```

```{r}
DJF_gnip_trim <- DJF_gnip[3:61,]
cor.test(DJF_gnip_trim$mean, group2_summary$mean)
```


C Seuss correction
Ask Amy - seems complicated

Corrected 13C = (tree ring 13C) - (atmosphere d13CO2 + pre-industrial d13CO2)
Pre-industrial is ~ -6.4 (I think)

Load in atmosphere data -> add pre-industrial -> subtract from tree ring 


```{r}
testdf<- read.csv("monthly_dc13_atm.csv")
testdf <- testdf[c(1,5)]
c13_atm <- testdf[5:170,]
colnames(c13_atm) <- c("Yr","C13")
c13_atm$C13 <- as.numeric(c13_atm$C13)
c13_atm$Yr <- c(1850:2015)
```

```{r}
plot(c13_atm[110:166,]$Yr, c13_atm[110:166,]$C13)
```

```{r}
baringhead <- read.csv("monthly_flask_c13_nzd.csv")
baringhead <- baringhead[5:432,c(1,8)]
BH_record <- baringhead %>% group_by(Yr) %>% summarise(mean = mean(C13..filled))
BH_correction <- mean(c13_atm[136:166,]$C13 - BH_record[1:31,]$mean)
c13_atm$BH_shift <- c13_atm$C13 - BH_correction
c13_atm[136:170,]$BH_shift <- BH_record[1:35,]$mean
```



```{r}
c13_atm$corrected <- (c13_atm$BH_shift + 6.51)
split_annual_c13 <- c13_atm[111:170,]
new_c13 <- tab2 - split_annual_c13$corrected
new_c13
```

```{r}
plot(new_c13[,2])
```



```{r}
std_13c <- data.frame(scale(new_c13))
std_13c <- std_13c[,-4]
c13_summary <- apply(new_c13[,-4], 1, median, na.rm=T)
c13_std_summary <- apply(std_13c, 1, median, na.rm=T)
```

```{r}
cors2 <- cor(new_c13[,-4], use="complete.obs")
mean(cors2[cors2!=1])
```


```{r}
plot(names(c13_summary), c13_summary)
```
Compare to uncorrected: 

```{r}
plot(names(rowMeans(tab2)), rowMeans(tab2[,-4], na.rm=TRUE))
```

While 1980ish is the period where a lot of different measurements come on, it appears that the jump is introduced by the tree rings, not the suess correction


Plotting Graven vs. Uncorrected Raw vs. Suess Corrected

```{r}
plot(c(1960:2018), rowMeans(scale(tab2[-4]), na.rm=TRUE), type="l",col="red")
lines(c(1960:2018), c13_std_summary, col="blue")
lines(c(1960:2018), scale(split_annual_c13[1:59,]$BH_shift), col="green")
```

Red = RAW uncorrected (except 606)
Blue = Suess-corrected
Green = Graven/BH record

Clearly the weird jump is introduced by the trees, not the atmospheric record







```{r}
cor(new_c13, use="complete.obs")
```


```{r}
cor.test(c13_summary, std_summary[1:59])
```

```{r}
c13_corrs <- function(df, trees){
  prevclim <- df[1:708,]
  newclim <- df[13:720,]
  nextclim <- df[25:732,]
  output <- data.frame(Clim="", Month="", Corr="", p="")
  for (param in c(3:ncol(df))){
    tempdf0 <- data.frame(Clim=colnames(df[param]), Month=c(11:12), Corr="", p="")
    tempdf <- data.frame(Clim=colnames(df[param]), Month=c(1:12), Corr="", p="")
    tempdf2 <- data.frame(Clim=colnames(df[param]), Month=c(1:5), Corr="", p="")
    for (m in 11:12){
      n = (m-10)
      mon_sub <- subset(prevclim, month == m)
      test <- cor.test(mon_sub[[param]], trees)
      tempdf0$Corr[n] <- test$estimate
      tempdf0$p[n] <- test$p.value
    }
    for (m in 1:12){
      mon_sub <- subset(newclim, month == m)
      test <- cor.test(mon_sub[[param]], trees)
      tempdf$Corr[m] <- test$estimate
      tempdf$p[m] <- test$p.value
    }
    for (m in 1:5){
      mon_sub <- subset(nextclim, month == m)
      test <- cor.test(mon_sub[[param]], trees)
      tempdf2$Corr[m] <- test$estimate
      tempdf2$p[m] <- test$p.value
    }
  output <- rbind(output, tempdf0, tempdf, tempdf2)
  }
  output <- output[-1,]
  output$Corr <- as.numeric(output$Corr)
  output$p <- as.numeric(output$p)
  output$Month <- c("P.Nov","P.Dec","P.Jan","P.Feb","P.Mar","P.Apr","P.May","Jun","Jul","Aug","Sep","Oct","Nov","Dec","Jan","Feb","Mar","Apr","May")
  return(output)
}
```

```{r}
plot(clim$temp, type="l")
```


```{r}
clim_for_carbon <- clim[,c(-3,-6,-7,-10,-11)]
```


```{r}
c13_df <- c13_corrs(clim_for_carbon, c13_summary)
c13_df$Month <- factor(c13_df$Month, levels=unique(c13_df$Month))
gg <- ggplot(c13_df, aes(x=Month, y=Clim, fill=Corr)) + geom_tile(color="white", size=0.1) + scale_fill_viridis(name="# Events") + coord_equal() + labs(x=NULL, y=NULL, title="Carbon Monthly Correlations")+geom_point(data=c13_df[c13_df$p<0.05,])
gg
```
Update after using BH: Not much left for relationships....


Relationship with VPD makes perfect sense
High VPD = closed stomata = "internal concentration of CO2 will drop and there will be less carboxylation discrimination against 13C, leading to higher d13C values"
I wonder why there is not a positive relationship with pdsi - drought should mean closed stomata
"d13C is only an indicator of drought stress in seasonally dry climates, and that variation in irradiance and N concentration can have as large an affect on discrimination as water availability"
Irradiance and temperature may be dominant in this environment, where moisture stress is not an issue
A negative relationship with solar radiation doesn't make sense at first - should lead to higher photosynthesis and thus higher 13C values
However, it isn't necessarily a negative relationship during the growing season - it's during the spring and fall
One possibility - higher irradiance in the spring and fall = sunny, but cold. Shouldn't be much photosynthesis happening (?)
It's also strange that temp and rad have near opposite relationships with carbon despite being positively related to each other

```{r}
monthtest <- subset(clim, month ==1)
plot(tab$X612, monthtest[3:61,]$gnip)
```


There is the possibility that this is not a very stressed area and the 13C signal will be difficult to interpret

No need to mess too much with the Suess stuff - Using the exact method described in McCarroll and Loader will result in the same relationships, just different numbered values. POSSIBLY find a different dataset that extends all the way to 1960 so that the whole dataset can be used.

Treeclim testing

```{r}
clim_for_treeclim <- clim[,c(1,2,4,5)]
```

```{r}
annual_summary <- as.data.frame(annual_summary)
rownames(annual_summary) <- (annual_summary$year + 1)
annual_summary[,1] <- NULL
annual_summary$samp.depth <- c(8,8,8,6,8,7,8,7,9,9,9,9,9,6,7,7,7,7,7,8,9,9,8,8,9,9,9,7,9,9,9,8,9,8,9,9,9,8,9,8,9,9,10,10,10,10,10,9,9,9,10,9,10,10,10,10,10,9,9)
```

```{r}
annual_summary$mean <- std_summary
```


```{r}
dcc(annual_summary, clim_for_treeclim, .range(-1:12))
```

Rad shows decent relationships in prev aug, prev dec, curr jun.


```{r}
sc1 <- seascorr(annual_summary, clim_for_treeclim, primary = "precip", secondary = "temp")
sc2 <- seascorr(annual_summary, clim_for_treeclim, primary = "temp", secondary = "precip")
plot(sc1)
plot(sc2)
```
Growing season/late growing season precip appears significant - but in the wrong direction

Previous year temp appears significant as well?

Explanation:
Positive relationship with prev spring temp could mean early summers - which means an early growing season - leading trees to take in more growing season 18O which is more enriched. Negative relationship in fall - neglgible but could still be season extension snafu? If it's warmer and trees are still recording O, but the signal is depleted somehow? This could mean that being warmer at the site doesn't necessarily mean it's warmer at the source.

Positive with late summer/fall precip. Definitely odd. But precip at the site may not be very influential anyway (except as a weak proxy for RH). More fall precip could mean winter came early, thus the trees stopped recording earlier. 

Both of these explanations mean that trees take signal from local climate as to when to start recording/stop recording 18O. This is predicated upon the assumption that 18O is only recorded during the growing season. A SOURCE WATER change could also be very influential here.

Questions: Why do relationships get so much stronger for partial corrs than they are for dcc? 
Is there a source region seasonal pattern that could cause this relationship when the season is extended in either direction? (As far as SAM goes, there does not appear to be a consistent seasonal trend)
DO these trees record just growing season? I think so - because if not, why is January the significant GNIP month?

Try with VPD (RH) and PET just to try it

```{r}
clim_for_treeclim2 <- clim[,c(1,2,5,6)]
clim_for_treeclim3 <- clim[,c(1,2,5,7)]
plot(seascorr(annual_summary, clim_for_treeclim2, primary = "vpd", secondary = "temp"))
plot(seascorr(annual_summary, clim_for_treeclim2, primary = "temp", secondary = "vpd"))
plot(seascorr(annual_summary, clim_for_treeclim3, primary = "pet", secondary = "temp"))
plot(seascorr(annual_summary, clim_for_treeclim3, primary = "temp", secondary = "pet"))
```

VPD and PET follow very similar patterns - strong positive correlations in Spring/early Summer
Would line up with temp trends in precip/temp partial corrs, but temp looks weaker here. Could this be due to the same seasonal extension I predicted before?
Although it appears I still need more info on how these partial corrs work. I'm unsure what the primary/secondary designation means exactly

TRIM SILO TO 90ish

MRD series:

```{r}
MRD <- read.csv("mrd.txt", sep=" ")
```

```{r}
rwd_corrs <- function(df, trees){
  prevclim <- df[1:708,]
  newclim <- df[13:720,]
  nextclim <- df[25:732,]
  output <- data.frame(Clim="", Month="", Corr="", p="")
  for (param in c(3:ncol(df))){
    tempdf0 <- data.frame(Clim=colnames(df[param]), Month=c(11:12), Corr="", p="")
    tempdf <- data.frame(Clim=colnames(df[param]), Month=c(1:12), Corr="", p="")
    tempdf2 <- data.frame(Clim=colnames(df[param]), Month=c(1:5), Corr="", p="")
    for (m in 11:12){
      n = (m-10)
      mon_sub <- subset(prevclim, month == m)
      test <- cor.test(mon_sub[[param]], trees)
      tempdf0$Corr[n] <- test$estimate
      tempdf0$p[n] <- test$p.value
    }
    for (m in 1:12){
      mon_sub <- subset(newclim, month == m)
      test <- cor.test(mon_sub[[param]], trees)
      tempdf$Corr[m] <- test$estimate
      tempdf$p[m] <- test$p.value
    }
    for (m in 1:5){
      mon_sub <- subset(nextclim, month == m)
      test <- cor.test(mon_sub[[param]], trees)
      tempdf2$Corr[m] <- test$estimate
      tempdf2$p[m] <- test$p.value
    }
  output <- rbind(output, tempdf0, tempdf, tempdf2)
  }
  output <- output[-1,]
  output$Corr <- as.numeric(output$Corr)
  output$p <- as.numeric(output$p)
  output$Month <- c("P.Nov","P.Dec","P.Jan","P.Feb","P.Mar","P.Apr","P.May","Jun","Jul","Aug","Sep","Oct","Nov","Dec","Jan","Feb","Mar","Apr","May")
  return(output)
}
```

```{r}
trimMRD <- MRD[2400:2458,]
```

```{r}
rwd_corrs(clim, trimMRD$mrdstd)
```

```{r}
mrd_df <- rwd_corrs(clim_for_carbon, trimMRD$mrdstd)
mrd_df$Month <- factor(mrd_df$Month, levels=unique(mrd_df$Month))
gg <- ggplot(mrd_df, aes(x=Month, y=Clim, fill=Corr)) + geom_tile(color="white", size=0.1) + scale_fill_viridis(name="# Events") + coord_equal() + labs(x=NULL, y=NULL, title="MRD Ring Width Monthly Correlations")+geom_point(data=mrd_df[mrd_df$p<0.05,])
gg
```

```{r}
dccMRD <- trimMRD
rownames(dccMRD) <- (as.numeric(rownames(trimMRD))+1)
dcc(dccMRD, clim_for_treeclim, .range(-1:12))
```

```{r}
sc1 <- seascorr(dccMRD, clim_for_treeclim, primary = "precip", secondary = "temp")
sc2 <- seascorr(dccMRD, clim_for_treeclim, primary = "temp", secondary = "precip")
plot(sc1)
plot(sc2)
```


Fine-tuning: Does GNIP CG reflect nearby GNIP stations?


```{r}
gnip_sites <- read.csv("other_gnip_sites.csv")
```

```{r}
plot(clim[217:600,]$gnip, gnip_sites$nz)
plot(clim[217:600,]$gnip, gnip_sites$margate)
cor.test(clim[217:600,]$gnip, gnip_sites$nz)
```

There is a bit of variability, but decent correlation with Invercargill site. Margate is too few data points to make anything of. Values are different, but there are different moisture sources, which makes that make sense.



Creating DJF Corrs (change season as needed)


This doesn't work, we can make it work?
```{r}
gs_corrs <- function(df, trees){
  prevclim <- df[1:708,]
  newclim <- df[13:720,]
  nextclim <- df[25:732,]
  output <- data.frame(Clim="", Month="", Corr="", p="")
  for (param in c(3:ncol(df))){
    tempdf0 <- data.frame(Clim=colnames(df[param]), Month=c(11:12), Corr="", p="")
    tempdf <- data.frame(Clim=colnames(df[param]), Month=c(1:12), Corr="", p="")
    tempdf2 <- data.frame(Clim=colnames(df[param]), Month=c(1:5), Corr="", p="")
    tempdf3 <- data.frame(Clim=colnames(df[param]), Month=c(13), Corr="", p="")
    for (m in 11:12){
      n = (m-10)
      mon_sub <- subset(prevclim, month == m)
      test <- cor.test(mon_sub[[param]], trees)
      tempdf0$Corr[n] <- test$estimate
      tempdf0$p[n] <- test$p.value
    }
    for (m in 1:12){
      mon_sub <- subset(newclim, month == m)
      test <- cor.test(mon_sub[[param]], trees)
      tempdf$Corr[m] <- test$estimate
      tempdf$p[m] <- test$p.value
    }
    for (m in 1:5){
      mon_sub <- subset(nextclim, month == m)
      test <- cor.test(mon_sub[[param]], trees)
      tempdf2$Corr[m] <- test$estimate
      tempdf2$p[m] <- test$p.value
    }
    dec_sub <- subset(newclim, month == 12)
    dec_sub$year <- (dec_sub$year + 1)
    djf_sub <- rbind(dec_sub, subset(nextclim, month == c(1,2)))
    djf_mean <- djf_sub %>% group_by(year)
    djf_sum <- summarise(djf_mean, mean = mean(as.formula(colnames(df[param])), na.rm=TRUE))
    djf_test <- cor.test(djf_sum$mean, trees)
    tempdf3[1]$Corr <- djf_test$estimate
    tempdf3[1]$p <- djf_test$p.value
  output <- rbind(output, tempdf0, tempdf, tempdf2, tempdf3)
  }
  output <- output[-1,]
  output$Corr <- as.numeric(output$Corr)
  output$p <- as.numeric(output$p)
  output$Month <- c("P.Nov","P.Dec","P.Jan","P.Feb","P.Mar","P.Apr","P.May","Jun","Jul","Aug","Sep","Oct","Nov","Dec","Jan","Feb","Mar","Apr","May","DJF")
  return(output)
}
```


THIS WORKS:
```{r}
dec_sub <- subset(clim[25:722,], month == c(1,2))
dec_sub$year <- (dec_sub$year - 1)
djf_sub <- rbind(dec_sub, subset(clim[13:722,], month == 12))
djf_mean <- djf_sub %>% group_by(year) %>% summarise(rad = mean(rad, na.rm=TRUE), precip = sum(precip, na.rm=TRUE), temp = mean(temp, na.rm=TRUE), vpd = mean(vpd, na.rm=TRUE), vpd = mean(vpd, na.rm=TRUE), rh = mean(rh, na.rm=TRUE))
djf_corrs <- data.frame(Clim=colnames(djf_mean[,-1]), Month=c("DJF"), Corr="", p="")
for (param in c(2:ncol(djf_mean))){
    m = param-1
    test <- cor.test(djf_mean[[param]], std_summary)
    djf_corrs[m,3] <- test$estimate
    djf_corrs[m,4] <- test$p.value
}
nov_sub <- subset(clim[25:722,], month == 1)
nov_sub$year <- (nov_sub$year - 1)
ndj_sub <- rbind(nov_sub, subset(clim[13:722,], month == c(11,12)))
ndj_mean <- ndj_sub %>% group_by(year) %>% summarise(rad = mean(rad, na.rm=TRUE), precip = sum(precip, na.rm=TRUE), temp = mean(temp, na.rm=TRUE), vpd = mean(vpd, na.rm=TRUE), vpd = mean(vpd, na.rm=TRUE), rh = mean(rh, na.rm=TRUE))
ndj_corrs <- data.frame(Clim=colnames(ndj_mean[,-1]), Month=c("NDJ"), Corr="", p="")
for (param in c(2:ncol(ndj_mean))){
    m = param-1
    test <- cor.test(ndj_mean[[param]], std_summary)
    ndj_corrs[m,3] <- test$estimate
    ndj_corrs[m,4] <- test$p.value
}
ond_sub <- subset(clim[13:722,], month == c(10,11,12))
ond_mean <- ond_sub %>% group_by(year) %>% summarise(rad = mean(rad, na.rm=TRUE), precip = sum(precip, na.rm=TRUE), temp = mean(temp, na.rm=TRUE), vpd = mean(vpd, na.rm=TRUE), vpd = mean(vpd, na.rm=TRUE), rh = mean(rh, na.rm=TRUE))
ond_corrs <- data.frame(Clim=colnames(ond_mean[,-1]), Month=c("OND"), Corr="", p="")
for (param in c(2:ncol(ond_mean))){
    m = param-1
    test <- cor.test(ond_mean[[param]], std_summary)
    ond_corrs[m,3] <- test$estimate
    ond_corrs[m,4] <- test$p.value
}
jfm_sub <- subset(clim[25:723,], month == c(1,2,3))
jfm_sub$year <- (jfm_sub$year - 1)
jfm_mean <- jfm_sub %>% group_by(year) %>% summarise(rad = mean(rad, na.rm=TRUE), precip = sum(precip, na.rm=TRUE), temp = mean(temp, na.rm=TRUE), vpd = mean(vpd, na.rm=TRUE), vpd = mean(vpd, na.rm=TRUE), rh = mean(rh, na.rm=TRUE))
jfm_corrs <- data.frame(Clim=colnames(jfm_mean[,-1]), Month=c("JFM"), Corr="", p="")
for (param in c(2:ncol(jfm_mean))){
    m = param-1
    test <- cor.test(jfm_mean[[param]], std_summary)
    jfm_corrs[m,3] <- test$estimate
    jfm_corrs[m,4] <- test$p.value
}
son_sub <- subset(clim[21:722,], month == c(9,10,11))
son_mean <- son_sub %>% group_by(year) %>% summarise(rad = mean(rad, na.rm=TRUE), precip = sum(precip, na.rm=TRUE), temp = mean(temp, na.rm=TRUE), vpd = mean(vpd, na.rm=TRUE), vpd = mean(vpd, na.rm=TRUE), rh = mean(rh, na.rm=TRUE))
son_corrs <- data.frame(Clim=colnames(son_mean[,-1]), Month=c("SON"), Corr="", p="")
for (param in c(2:ncol(son_mean))){
    m = param-1
    test <- cor.test(son_mean[[param]], std_summary)
    son_corrs[m,3] <- test$estimate
    son_corrs[m,4] <- test$p.value
}
sf_sub <- subset(clim[25:722,], month == c(1,2))
sf_sub$year <- (sf_sub$year - 1)
full_sub <- rbind(sf_sub, subset(clim[13:722,], month == c(9,10,11,12)))
full_mean <- full_sub %>% group_by(year) %>% summarise(rad = mean(rad, na.rm=TRUE), precip = sum(precip, na.rm=TRUE), temp = mean(temp, na.rm=TRUE), vpd = mean(vpd, na.rm=TRUE), vpd = mean(vpd, na.rm=TRUE), rh = mean(rh, na.rm=TRUE))
full_corrs <- data.frame(Clim=colnames(full_mean[,-1]), Month=c("SONDJF"), Corr="", p="")
for (param in c(2:ncol(full_mean))){
    m = param-1
    test <- cor.test(full_mean[[param]], std_summary)
    full_corrs[m,3] <- test$estimate
    full_corrs[m,4] <- test$p.value
}

seas_corrs <- rbind(son_corrs, ond_corrs,ndj_corrs,djf_corrs,jfm_corrs, full_corrs)
seas_corrs$Corr <- as.numeric(seas_corrs$Corr)
seas_corrs$p <- as.numeric(seas_corrs$p)
```
fma_sub <- subset(clim[26:724,], month == c(2,3,4))
fma_sub$year <- (fma_sub$year - 1)
fma_mean <- fma_sub %>% group_by(year) %>% summarise(rad = mean(rad, na.rm=TRUE), precip = sum(precip, na.rm=TRUE), temp = mean(temp, na.rm=TRUE), vpd = mean(vpd, na.rm=TRUE), vpd = mean(vpd, na.rm=TRUE), rh = mean(rh, na.rm=TRUE))
fma_corrs <- data.frame(Clim=colnames(fma_mean[,-1]), Month=c("FMA"), Corr="", p="")
for (param in c(2:ncol(fma_mean))){
    m = param-1
    test <- cor.test(fma_mean[[param]], std_summary)
    fma_corrs[m,3] <- test$estimate
    fma_corrs[m,4] <- test$p.value
}
mam_sub <- subset(clim[27:725,], month == c(3,4,5))
mam_sub$year <- (mam_sub$year - 1)
mam_mean <- mam_sub %>% group_by(year) %>% summarise(rad = mean(rad, na.rm=TRUE), precip = sum(precip, na.rm=TRUE), temp = mean(temp, na.rm=TRUE), vpd = mean(vpd, na.rm=TRUE), vpd = mean(vpd, na.rm=TRUE), rh = mean(rh, na.rm=TRUE))
mam_corrs <- data.frame(Clim=colnames(mam_mean[,-1]), Month=c("MAM"), Corr="", p="")
for (param in c(2:ncol(mam_mean))){
    m = param-1
    test <- cor.test(mam_mean[[param]], std_summary)
    mam_corrs[m,3] <- test$estimate
    mam_corrs[m,4] <- test$p.value
}
amj_sub <- subset(clim[28:726,], month == c(4,5,6))
amj_sub$year <- (amj_sub$year - 1)
amj_mean <- amj_sub %>% group_by(year) %>% summarise(rad = mean(rad, na.rm=TRUE), precip = sum(precip, na.rm=TRUE), temp = mean(temp, na.rm=TRUE), vpd = mean(vpd, na.rm=TRUE), vpd = mean(vpd, na.rm=TRUE), rh = mean(rh, na.rm=TRUE))
amj_corrs <- data.frame(Clim=colnames(amj_mean[,-1]), Month=c("AMJ"), Corr="", p="")
for (param in c(2:ncol(amj_mean))){
    m = param-1
    test <- cor.test(amj_mean[[param]], std_summary)
    amj_corrs[m,3] <- test$estimate
    amj_corrs[m,4] <- test$p.value
}


Plot
```{r}

seas_corrs$Month <- factor(seas_corrs$Month, levels=unique(seas_corrs$Month))
gg <- ggplot(seas_corrs, aes(x=Month, y=Clim, fill=Corr)) + 
geom_tile(color="white", size=0.1) +
scale_fill_viridis(name="Pearson's r", breaks=c(-0.5,-0.25,0,0.25,0.5), limits=c(-0.6,0.6)) + 
coord_equal() +
labs(x=NULL, y=NULL, title="d18O Correlations")+
scale_y_discrete(labels=c("Precipitation","Solar Radiation","RH","Temp","VPD"))+
geom_point(data=seas_corrs[seas_corrs$p<0.05,])
png(file="o18corr.png")
gg
dev.off()
```

```{r}
dec_sub <- subset(clim[25:722,], month == c(1,2))
dec_sub$year <- (dec_sub$year - 1)
djf_sub <- rbind(dec_sub, subset(clim[13:722,], month == 12))
djf_mean <- djf_sub %>% group_by(year) %>% summarise(gnip=mean(gnip, na.rm=TRUE))
djf_corrs <- data.frame(Clim=colnames(djf_mean[,-1]), Month=c("DJF"), Corr="", p="")
for (param in c(2:ncol(djf_mean))){
    m = param-1
    test <- cor.test(djf_mean[[param]], std_summary)
    djf_corrs[m,3] <- test$estimate
    djf_corrs[m,4] <- test$p.value
}
nov_sub <- subset(clim[25:722,], month == 1)
nov_sub$year <- (nov_sub$year - 1)
ndj_sub <- rbind(nov_sub, subset(clim[13:722,], month == c(11,12)))
ndj_mean <- ndj_sub %>% group_by(year) %>% summarise(gnip=mean(gnip, na.rm=TRUE))
ndj_corrs <- data.frame(Clim=colnames(ndj_mean[,-1]), Month=c("NDJ"), Corr="", p="")
for (param in c(2:ncol(ndj_mean))){
    m = param-1
    test <- cor.test(ndj_mean[[param]], std_summary)
    ndj_corrs[m,3] <- test$estimate
    ndj_corrs[m,4] <- test$p.value
}
ond_sub <- subset(clim[13:722,], month == c(10,11,12))
ond_mean <- ond_sub %>% group_by(year) %>% summarise(gnip=mean(gnip, na.rm=TRUE))
ond_corrs <- data.frame(Clim=colnames(ond_mean[,-1]), Month=c("OND"), Corr="", p="")
for (param in c(2:ncol(ond_mean))){
    m = param-1
    test <- cor.test(ond_mean[[param]], std_summary)
    ond_corrs[m,3] <- test$estimate
    ond_corrs[m,4] <- test$p.value
}
jfm_sub <- subset(clim[25:723,], month == c(1,2,3))
jfm_sub$year <- (jfm_sub$year - 1)
jfm_mean <- jfm_sub %>% group_by(year) %>% summarise(gnip=mean(gnip, na.rm=TRUE))
jfm_corrs <- data.frame(Clim=colnames(jfm_mean[,-1]), Month=c("JFM"), Corr="", p="")
for (param in c(2:ncol(jfm_mean))){
    m = param-1
    test <- cor.test(jfm_mean[[param]], std_summary)
    jfm_corrs[m,3] <- test$estimate
    jfm_corrs[m,4] <- test$p.value
}
son_sub <- subset(clim[21:722,], month == c(9,10,11))
son_mean <- son_sub %>% group_by(year) %>% summarise(gnip=mean(gnip, na.rm=TRUE))
son_corrs <- data.frame(Clim=colnames(son_mean[,-1]), Month=c("SON"), Corr="", p="")
for (param in c(2:ncol(son_mean))){
    m = param-1
    test <- cor.test(son_mean[[param]], std_summary)
    son_corrs[m,3] <- test$estimate
    son_corrs[m,4] <- test$p.value
}
sf_sub <- subset(clim[25:722,], month == c(1,2))
sf_sub$year <- (sf_sub$year - 1)
full_sub <- rbind(sf_sub, subset(clim[13:722,], month == c(9,10,11,12)))
full_mean <- full_sub %>% group_by(year) %>% summarise(gnip=mean(gnip, na.rm=TRUE))
full_corrs <- data.frame(Clim=colnames(full_mean[,-1]), Month=c("SONDJF"), Corr="", p="")
for (param in c(2:ncol(full_mean))){
    m = param-1
    test <- cor.test(full_mean[[param]], std_summary)
    full_corrs[m,3] <- test$estimate
    full_corrs[m,4] <- test$p.value
}

seas_corrs <- rbind(son_corrs, ond_corrs,ndj_corrs,djf_corrs,jfm_corrs, full_corrs)
seas_corrs$Corr <- as.numeric(seas_corrs$Corr)
seas_corrs$p <- as.numeric(seas_corrs$p)
```

```{r}
seas_corrs$Month <- factor(seas_corrs$Month, levels=unique(seas_corrs$Month))
gg <- ggplot(seas_corrs, aes(x=Month, y=Clim, fill=Corr)) + 
geom_tile(color="white", size=0.1) +
scale_fill_viridis(name="Pearson's r", breaks=c(-0.5,-0.25,0,0.25,0.5), limits=c(-0.6,0.6)) + 
coord_equal() +
labs(x=NULL, y=NULL, title="GNIP ~ d18O Correlations")+
scale_y_discrete(labels=c("GNIP"))+
geom_point(data=seas_corrs[seas_corrs$p<0.05,])
gg
```

```{r}
ndj_mean$o18 <- std_summary
lm_gnip <- lm(o18 ~ gnip, data=ndj_mean)
summary(lm_gnip)
```


```{r}
png(file="GNIPcomp.png", height = 600, width = 600)
ggplot(data=ndj_mean, aes(x=gnip, y=o18))+
  geom_point()+
  geom_abline(intercept= lm_gnip$coefficients[1], slope=lm_gnip$coefficients[2], col="red")+
   labs(y= "KBP δ18O (‰)", x = "November - January δ18Op (‰) at Cape Grim")
dev.off()
```



CARBON:
```{r}
dec_sub <- subset(clim[25:722,], month == c(1,2))
dec_sub$year <- (dec_sub$year - 1)
djf_sub <- rbind(dec_sub, subset(clim[13:722,], month == 12))
djf_mean <- djf_sub %>% group_by(year) %>% summarise(rad = mean(rad, na.rm=TRUE), precip = sum(precip, na.rm=TRUE), temp = mean(temp, na.rm=TRUE), vpd = mean(vpd, na.rm=TRUE), vpd = mean(vpd, na.rm=TRUE), rh = mean(rh, na.rm=TRUE))
djf_corrs <- data.frame(Clim=colnames(djf_mean[,-1]), Month=c("DJF"), Corr="", p="")
for (param in c(2:ncol(djf_mean))){
    m = param-1
    test <- cor.test(djf_mean[[param]], c13_summary)
    djf_corrs[m,3] <- test$estimate
    djf_corrs[m,4] <- test$p.value
}
nov_sub <- subset(clim[25:722,], month == 1)
nov_sub$year <- (nov_sub$year - 1)
ndj_sub <- rbind(nov_sub, subset(clim[13:722,], month == c(11,12)))
ndj_mean <- ndj_sub %>% group_by(year) %>% summarise(rad = mean(rad, na.rm=TRUE), precip = sum(precip, na.rm=TRUE), temp = mean(temp, na.rm=TRUE), vpd = mean(vpd, na.rm=TRUE), vpd = mean(vpd, na.rm=TRUE), rh = mean(rh, na.rm=TRUE))
ndj_corrs <- data.frame(Clim=colnames(ndj_mean[,-1]), Month=c("NDJ"), Corr="", p="")
for (param in c(2:ncol(ndj_mean))){
    m = param-1
    test <- cor.test(ndj_mean[[param]], c13_summary)
    ndj_corrs[m,3] <- test$estimate
    ndj_corrs[m,4] <- test$p.value
}
ond_sub <- subset(clim[13:722,], month == c(10,11,12))
ond_mean <- ond_sub %>% group_by(year) %>% summarise(rad = mean(rad, na.rm=TRUE), precip = sum(precip, na.rm=TRUE), temp = mean(temp, na.rm=TRUE), vpd = mean(vpd, na.rm=TRUE), vpd = mean(vpd, na.rm=TRUE), rh = mean(rh, na.rm=TRUE))
ond_corrs <- data.frame(Clim=colnames(ond_mean[,-1]), Month=c("OND"), Corr="", p="")
for (param in c(2:ncol(ond_mean))){
    m = param-1
    test <- cor.test(ond_mean[[param]], c13_summary)
    ond_corrs[m,3] <- test$estimate
    ond_corrs[m,4] <- test$p.value
}
jfm_sub <- subset(clim[25:723,], month == c(1,2,3))
jfm_sub$year <- (jfm_sub$year - 1)
jfm_mean <- jfm_sub %>% group_by(year) %>% summarise(rad = mean(rad, na.rm=TRUE), precip = sum(precip, na.rm=TRUE), temp = mean(temp, na.rm=TRUE), vpd = mean(vpd, na.rm=TRUE), vpd = mean(vpd, na.rm=TRUE), rh = mean(rh, na.rm=TRUE))
jfm_corrs <- data.frame(Clim=colnames(jfm_mean[,-1]), Month=c("JFM"), Corr="", p="")
for (param in c(2:ncol(jfm_mean))){
    m = param-1
    test <- cor.test(jfm_mean[[param]], c13_summary)
    jfm_corrs[m,3] <- test$estimate
    jfm_corrs[m,4] <- test$p.value
}
son_sub <- subset(clim[21:722,], month == c(9,10,11))
son_mean <- son_sub %>% group_by(year) %>% summarise(rad = mean(rad, na.rm=TRUE), precip = sum(precip, na.rm=TRUE), temp = mean(temp, na.rm=TRUE), vpd = mean(vpd, na.rm=TRUE), vpd = mean(vpd, na.rm=TRUE), rh = mean(rh, na.rm=TRUE))
son_corrs <- data.frame(Clim=colnames(son_mean[,-1]), Month=c("SON"), Corr="", p="")
for (param in c(2:ncol(son_mean))){
    m = param-1
    test <- cor.test(son_mean[[param]], c13_summary)
    son_corrs[m,3] <- test$estimate
    son_corrs[m,4] <- test$p.value
}
sf_sub <- subset(clim[25:722,], month == c(1,2))
sf_sub$year <- (sf_sub$year - 1)
full_sub <- rbind(sf_sub, subset(clim[13:722,], month == c(9,10,11,12)))
full_mean <- full_sub %>% group_by(year) %>% summarise(rad = mean(rad, na.rm=TRUE), precip = sum(precip, na.rm=TRUE), temp = mean(temp, na.rm=TRUE), vpd = mean(vpd, na.rm=TRUE), vpd = mean(vpd, na.rm=TRUE), rh = mean(rh, na.rm=TRUE))
full_corrs <- data.frame(Clim=colnames(full_mean[,-1]), Month=c("SONDJF"), Corr="", p="")
for (param in c(2:ncol(full_mean))){
    m = param-1
    test <- cor.test(full_mean[[param]], c13_summary)
    full_corrs[m,3] <- test$estimate
    full_corrs[m,4] <- test$p.value
}

seas_corrs <- rbind(son_corrs, ond_corrs,ndj_corrs,djf_corrs,jfm_corrs,full_corrs)
seas_corrs$Corr <- as.numeric(seas_corrs$Corr)
seas_corrs$p <- as.numeric(seas_corrs$p)
```

```{r}
seas_corrs$Month <- factor(seas_corrs$Month, levels=unique(seas_corrs$Month))
gg <- ggplot(seas_corrs, aes(x=Month, y=Clim, fill=Corr)) + 
geom_tile(color="white", size=0.1) +
scale_fill_viridis(name="Pearson's r", breaks=c(-0.5,-0.25,0,0.25,0.5), limits=c(-0.6,0.6)) + 
coord_equal() +
labs(x=NULL, y=NULL, title="d13C Correlations")+
scale_y_discrete(labels=c("Precipitation","Solar Radiation","RH","Temp","VPD"))+
geom_point(data=seas_corrs[seas_corrs$p<0.05,])
png(file="c13corr.png")
gg
dev.off()
```


RING WIDTH:
```{r}
dec_sub <- subset(clim[25:722,], month == c(1,2))
dec_sub$year <- (dec_sub$year - 1)
djf_sub <- rbind(dec_sub, subset(clim[13:722,], month == 12))
djf_mean <- djf_sub %>% group_by(year) %>% summarise(rad = mean(rad, na.rm=TRUE), precip = sum(precip, na.rm=TRUE), temp = mean(temp, na.rm=TRUE), vpd = mean(vpd, na.rm=TRUE), vpd = mean(vpd, na.rm=TRUE), rh = mean(rh, na.rm=TRUE))
djf_corrs <- data.frame(Clim=colnames(djf_mean[,-1]), Month=c("DJF"), Corr="", p="")
for (param in c(2:ncol(djf_mean))){
    m = param-1
    test <- cor.test(djf_mean[[param]], trimMRD$mrdstd)
    djf_corrs[m,3] <- test$estimate
    djf_corrs[m,4] <- test$p.value
}
nov_sub <- subset(clim[25:722,], month == 1)
nov_sub$year <- (nov_sub$year - 1)
ndj_sub <- rbind(nov_sub, subset(clim[13:722,], month == c(11,12)))
ndj_mean <- ndj_sub %>% group_by(year) %>% summarise(rad = mean(rad, na.rm=TRUE), precip = sum(precip, na.rm=TRUE), temp = mean(temp, na.rm=TRUE), vpd = mean(vpd, na.rm=TRUE), vpd = mean(vpd, na.rm=TRUE), rh = mean(rh, na.rm=TRUE))
ndj_corrs <- data.frame(Clim=colnames(ndj_mean[,-1]), Month=c("NDJ"), Corr="", p="")
for (param in c(2:ncol(ndj_mean))){
    m = param-1
    test <- cor.test(ndj_mean[[param]], trimMRD$mrdstd)
    ndj_corrs[m,3] <- test$estimate
    ndj_corrs[m,4] <- test$p.value
}
ond_sub <- subset(clim[13:722,], month == c(10,11,12))
ond_mean <- ond_sub %>% group_by(year) %>% summarise(rad = mean(rad, na.rm=TRUE), precip = sum(precip, na.rm=TRUE), temp = mean(temp, na.rm=TRUE), vpd = mean(vpd, na.rm=TRUE), vpd = mean(vpd, na.rm=TRUE), rh = mean(rh, na.rm=TRUE))
ond_corrs <- data.frame(Clim=colnames(ond_mean[,-1]), Month=c("OND"), Corr="", p="")
for (param in c(2:ncol(ond_mean))){
    m = param-1
    test <- cor.test(ond_mean[[param]], trimMRD$mrdstd)
    ond_corrs[m,3] <- test$estimate
    ond_corrs[m,4] <- test$p.value
}
jfm_sub <- subset(clim[25:723,], month == c(1,2,3))
jfm_sub$year <- (jfm_sub$year - 1)
jfm_mean <- jfm_sub %>% group_by(year) %>% summarise(rad = mean(rad, na.rm=TRUE), precip = sum(precip, na.rm=TRUE), temp = mean(temp, na.rm=TRUE), vpd = mean(vpd, na.rm=TRUE), vpd = mean(vpd, na.rm=TRUE), rh = mean(rh, na.rm=TRUE))
jfm_corrs <- data.frame(Clim=colnames(jfm_mean[,-1]), Month=c("JFM"), Corr="", p="")
for (param in c(2:ncol(jfm_mean))){
    m = param-1
    test <- cor.test(jfm_mean[[param]], trimMRD$mrdstd)
    jfm_corrs[m,3] <- test$estimate
    jfm_corrs[m,4] <- test$p.value
}
son_sub <- subset(clim[21:722,], month == c(9,10,11))
son_mean <- son_sub %>% group_by(year) %>% summarise(rad = mean(rad, na.rm=TRUE), precip = sum(precip, na.rm=TRUE), temp = mean(temp, na.rm=TRUE), vpd = mean(vpd, na.rm=TRUE), vpd = mean(vpd, na.rm=TRUE), rh = mean(rh, na.rm=TRUE))
son_corrs <- data.frame(Clim=colnames(son_mean[,-1]), Month=c("SON"), Corr="", p="")
for (param in c(2:ncol(son_mean))){
    m = param-1
    test <- cor.test(son_mean[[param]], trimMRD$mrdstd)
    son_corrs[m,3] <- test$estimate
    son_corrs[m,4] <- test$p.value
}
sf_sub <- subset(clim[25:722,], month == c(1,2))
sf_sub$year <- (sf_sub$year - 1)
full_sub <- rbind(sf_sub, subset(clim[13:722,], month == c(9,10,11,12)))
full_mean <- full_sub %>% group_by(year) %>% summarise(rad = mean(rad, na.rm=TRUE), precip = sum(precip, na.rm=TRUE), temp = mean(temp, na.rm=TRUE), vpd = mean(vpd, na.rm=TRUE), vpd = mean(vpd, na.rm=TRUE), rh = mean(rh, na.rm=TRUE))
full_corrs <- data.frame(Clim=colnames(full_mean[,-1]), Month=c("SONDJF"), Corr="", p="")
for (param in c(2:ncol(full_mean))){
    m = param-1
    test <- cor.test(full_mean[[param]], trimMRD$mrdstd)
    full_corrs[m,3] <- test$estimate
    full_corrs[m,4] <- test$p.value
}

seas_corrs <- rbind(son_corrs, ond_corrs,ndj_corrs,djf_corrs,jfm_corrs, full_corrs)
seas_corrs$Corr <- as.numeric(seas_corrs$Corr)
seas_corrs$p <- as.numeric(seas_corrs$p)
```



```{r}
seas_corrs$Month <- factor(seas_corrs$Month, levels=unique(seas_corrs$Month))
gg <- ggplot(seas_corrs, aes(x=Month, y=Clim, fill=Corr)) + 
geom_tile(color="white", size=0.1) +
scale_fill_viridis(name="Pearson's r", breaks=c(-0.5,-0.25,0,0.25,0.5), limits=c(-0.6,0.6)) + 
coord_equal() +
labs(x=NULL, y=NULL, title="Ring Width Correlations")+
scale_y_discrete(labels=c("Precipitation","Solar Radiation","RH","Temp","VPD"))+
geom_point(data=seas_corrs[seas_corrs$p<0.05,])
png(file="rwdcorr.png")
gg
dev.off()
```

```{r}
dec_sub <- subset(clim[25:722,], month == c(1,2))
dec_sub$year <- (dec_sub$year - 1)
djf_sub <- rbind(dec_sub, subset(clim[13:722,], month == 12))
djf_mean <- djf_sub %>% group_by(year) %>% summarise(rad = mean(rad, na.rm=TRUE), precip = sum(precip, na.rm=TRUE), temp = mean(temp, na.rm=TRUE), vpd = mean(vpd, na.rm=TRUE), vpd = mean(vpd, na.rm=TRUE), rh = mean(rh, na.rm=TRUE))
djf_corrs <- data.frame(Clim=colnames(djf_mean[,-1]), Month=c("DJF"), Corr="", p="")
for (param in c(2:ncol(djf_mean))){
    m = param-1
    test <- cor.test(djf_mean[[param]], sd_vals)
    djf_corrs[m,3] <- test$estimate
    djf_corrs[m,4] <- test$p.value
}
nov_sub <- subset(clim[25:722,], month == 1)
nov_sub$year <- (nov_sub$year - 1)
ndj_sub <- rbind(nov_sub, subset(clim[13:722,], month == c(11,12)))
ndj_mean <- ndj_sub %>% group_by(year) %>% summarise(rad = mean(rad, na.rm=TRUE), precip = sum(precip, na.rm=TRUE), temp = mean(temp, na.rm=TRUE), vpd = mean(vpd, na.rm=TRUE), vpd = mean(vpd, na.rm=TRUE), rh = mean(rh, na.rm=TRUE))
ndj_corrs <- data.frame(Clim=colnames(ndj_mean[,-1]), Month=c("NDJ"), Corr="", p="")
for (param in c(2:ncol(ndj_mean))){
    m = param-1
    test <- cor.test(ndj_mean[[param]], sd_vals)
    ndj_corrs[m,3] <- test$estimate
    ndj_corrs[m,4] <- test$p.value
}
ond_sub <- subset(clim[13:722,], month == c(10,11,12))
ond_mean <- ond_sub %>% group_by(year) %>% summarise(rad = mean(rad, na.rm=TRUE), precip = sum(precip, na.rm=TRUE), temp = mean(temp, na.rm=TRUE), vpd = mean(vpd, na.rm=TRUE), vpd = mean(vpd, na.rm=TRUE), rh = mean(rh, na.rm=TRUE))
ond_corrs <- data.frame(Clim=colnames(ond_mean[,-1]), Month=c("OND"), Corr="", p="")
for (param in c(2:ncol(ond_mean))){
    m = param-1
    test <- cor.test(ond_mean[[param]], sd_vals)
    ond_corrs[m,3] <- test$estimate
    ond_corrs[m,4] <- test$p.value
}
jfm_sub <- subset(clim[25:723,], month == c(1,2,3))
jfm_sub$year <- (jfm_sub$year - 1)
jfm_mean <- jfm_sub %>% group_by(year) %>% summarise(rad = mean(rad, na.rm=TRUE), precip = sum(precip, na.rm=TRUE), temp = mean(temp, na.rm=TRUE), vpd = mean(vpd, na.rm=TRUE), vpd = mean(vpd, na.rm=TRUE), rh = mean(rh, na.rm=TRUE))
jfm_corrs <- data.frame(Clim=colnames(jfm_mean[,-1]), Month=c("JFM"), Corr="", p="")
for (param in c(2:ncol(jfm_mean))){
    m = param-1
    test <- cor.test(jfm_mean[[param]], sd_vals)
    jfm_corrs[m,3] <- test$estimate
    jfm_corrs[m,4] <- test$p.value
}
son_sub <- subset(clim[21:722,], month == c(9,10,11))
son_mean <- son_sub %>% group_by(year) %>% summarise(rad = mean(rad, na.rm=TRUE), precip = sum(precip, na.rm=TRUE), temp = mean(temp, na.rm=TRUE), vpd = mean(vpd, na.rm=TRUE), vpd = mean(vpd, na.rm=TRUE), rh = mean(rh, na.rm=TRUE))
son_corrs <- data.frame(Clim=colnames(son_mean[,-1]), Month=c("SON"), Corr="", p="")
for (param in c(2:ncol(son_mean))){
    m = param-1
    test <- cor.test(son_mean[[param]], sd_vals)
    son_corrs[m,3] <- test$estimate
    son_corrs[m,4] <- test$p.value
}
sf_sub <- subset(clim[25:722,], month == c(1,2))
sf_sub$year <- (sf_sub$year - 1)
full_sub <- rbind(sf_sub, subset(clim[13:722,], month == c(9,10,11,12)))
full_mean <- full_sub %>% group_by(year) %>% summarise(rad = mean(rad, na.rm=TRUE), precip = sum(precip, na.rm=TRUE), temp = mean(temp, na.rm=TRUE), vpd = mean(vpd, na.rm=TRUE), vpd = mean(vpd, na.rm=TRUE), rh = mean(rh, na.rm=TRUE))
full_corrs <- data.frame(Clim=colnames(full_mean[,-1]), Month=c("SONDJF"), Corr="", p="")
for (param in c(2:ncol(full_mean))){
    m = param-1
    test <- cor.test(full_mean[[param]], sd_vals)
    full_corrs[m,3] <- test$estimate
    full_corrs[m,4] <- test$p.value
}

seas_corrs <- rbind(son_corrs, ond_corrs,ndj_corrs,djf_corrs,jfm_corrs, full_corrs)
seas_corrs$Corr <- as.numeric(seas_corrs$Corr)
seas_corrs$p <- as.numeric(seas_corrs$p)
```

```{r}
seas_corrs$Month <- factor(seas_corrs$Month, levels=unique(seas_corrs$Month))
gg <- ggplot(seas_corrs, aes(x=Month, y=Clim, fill=Corr)) + 
geom_tile(color="white", size=0.1) +
scale_fill_viridis(name="Pearson's r", breaks=c(-0.5,-0.25,0,0.25,0.5), limits=c(-0.6,0.6)) + 
coord_equal() +
labs(x=NULL, y=NULL, title="18O SD Correlations")+
scale_y_discrete(labels=c("Precipitation","Solar Radiation","RH","Temp","VPD"))+
geom_point(data=seas_corrs[seas_corrs$p<0.05,])
png(file="sdcorr.png")
gg
dev.off
```

```{r}
plot(ond_mean$rad)
```


```{r}
plot(full_mean$temp, sd_vals)
```



```{r}
plot(ffcsaps(y= std_summary, x=c(1960:2018), nyrs=10, f=0.9))
```


```{r}
library(boot)

ci.func <- function(y){
  y <- y[!is.na(y)]
  med.fun <- function(y,i)
  {
    m = median(y[i])
    n = length(i)
    v =(n-1)*var(y[i])/n^2
    c(m,v)
  }
  y.boot = boot(y, med.fun, R=1000)
  y.ci=boot.ci(y.boot, conf = 0.95, type = 'basic')
  y.ci=y.ci$basic[c(4,5)]
  names(y.ci)=c('lower','upper')
  y.ci
}
ci.func50 <- function(y){
  y <- y[!is.na(y)]
  med.fun <- function(y,i)
  {
    m = median(y[i])
    n = length(i)
    v =(n-1)*var(y[i])/n^2
    c(m,v)
  }
  y.boot = boot(y, med.fun, R=1000)
  y.ci=boot.ci(y.boot, conf = 0.50, type = 'basic')
  y.ci=y.ci$basic[c(4,5)]
  names(y.ci)=c('lower','upper')
  y.ci
}
```

```{r}
spline <- ffcsaps(y= std_summary, x=c(1960:2018), nyrs=10, f=0.9)
```


```{r}
ci <- as.data.frame(t(apply(tab, 1, ci.func)))
ci$med <- as.numeric("")
ci$med <- spline
ci$year <- rownames(ci)
ci50 <- as.data.frame(t(apply(tab, 1, ci.func50)))
ci$up.tight <- ci50$upper
ci$low.tight <- ci50$lower
ci$year <- as.numeric(ci$year)
ci$trumed <- std_summary
```

```{r}
lm_18O<- lm(trumed~year, data=ci)
```

```{r}
summary(lm_18O)
```


```{r}
p<-ggplot(data=ci, aes(x=year, group=1)) +
  geom_line(aes(y = trumed), color="steelblue" )+
  
  geom_ribbon(aes(ymin=lower, ymax=upper, fill="95% confidence interval of median d18O"), linetype=2, alpha=0.3)+
  geom_line(aes(y=med),size=2, col="darkslategrey")+
  geom_abline(intercept= lm_18O$coefficients[1], slope=lm_18O$coefficients[2], col="red")+
  labs(y= "KBP δ18O (‰)", x = "Year")+
  scale_x_continuous(breaks=seq(1960,2020,10))+
  scale_fill_manual("",values="darkgreen")+
  theme(
    text = element_text(size=20),
    legend.position = c(.95, .05),
    legend.justification = c("right", "bottom"),
    legend.box.just = "right",
    legend.margin = margin(0,5,5, 5)
    )+
  scale_linetype(name = NULL)
png(filename="o18series.png", height=700, width=1200)
p
dev.off()
```

CARBON:

```{r}
splineC <- ffcsaps(y= c13_summary, x=c(1960:2018), nyrs=10, f=0.9)
```


```{r}
ciC <- as.data.frame(t(apply(new_c13[,-4], 1, ci.func)))
ciC$med <- as.numeric("")
ciC$med <- splineC
ciC$year <- rownames(ciC)
ciC50 <- as.data.frame(t(apply(new_c13[,-4], 1, ci.func50)))
ciC$up.tight <- ciC50$upper
ciC$low.tight <- ciC50$lower
ciC$year <- as.numeric(ciC$year)
ciC$trumed <- c13_summary
```

```{r}
lm_13C<- lm(trumed~year, data=ciC)
```

```{r}
summary(lm_13C)
```


```{r}
p<-ggplot(data=ciC, aes(x=year, group=1)) +
  geom_line(aes(y = trumed), color="steelblue" )+
  geom_ribbon(aes(ymin=lower, ymax=upper, fill="95% confidence interval of median d13C"), linetype=2, alpha=0.3)+
    geom_line(aes(y=med),size=2, col="darkslategrey")+
  geom_abline(intercept= lm_13C$coefficients[1], slope=lm_13C$coefficients[2], col="red")+
  labs(y= "KBP δ13C (‰)", x = "Year")+
  scale_x_continuous(breaks=seq(1960,2020,10))+
  scale_fill_manual("",values="darkgreen")+
  theme(
    text = element_text(size=20),
    legend.position = c(.95, .95),
    legend.justification = c("right", "top"),
    legend.box.just = "right",
    legend.margin = margin(0,5,5, 5)
    )+
  scale_linetype(name = NULL)
png(filename="c13series.png", height=700, width=1200)
p
dev.off()
```




Bringing in maps

```{r}
r1 <- raster("rasters/results/t2m/t2m_corr_test_curr_06.gri")
r2 <- raster("rasters/results/t2m/t2m_corr_test_curr_07.gri")
r3 <- raster("rasters/results/t2m/t2m_corr_test_curr_08.gri")
r4 <- raster("rasters/results/t2m/t2m_corr_test_curr_09.gri")
r5 <- raster("rasters/results/t2m/t2m_corr_test_curr_10.gri")
r6 <-raster("rasters/results/t2m/t2m_corr_test_curr_11.gri")
r7 <-raster("rasters/results/t2m/t2m_corr_test_curr_12.gri")
r8 <-raster("rasters/results/t2m/t2m_corr_test_next_01.gri")
r9 <-raster("rasters/results/t2m/t2m_corr_test_next_02.gri")
r10 <-raster("rasters/results/t2m/t2m_corr_test_next_03.gri")
r11 <-raster("rasters/results/t2m/t2m_corr_test_next_04.gri")
r12 <-raster("rasters/results/t2m/t2m_corr_test_next_05.gri")
s <- stack(r1, r2, r3, r4, r5, r6, r7, r8, r9, r10, r11, r12)
b <- brick(s)
names(b) <- c("prevjun","prevjul","prevaug","prevsep","prevoct","prevnov","prevdec","nextjan","nextfeb","nextmar","nextapr","nextmay")
writeRaster(b, "t2m_corr_results", overwrite=TRUE)
```

Now: 
-Trim somehow? May require Arc
-Try DJF/seasonal


```{r}
plot(brick("rasters/results/rh_corr_results.gri"))
```

```{r}
evap_brick <- brick("rasters/results/precip_corr_results.gri")
```


```{r}
plot(evap_brick$nextfeb)
plot(coastsCoarse,add=TRUE)
```


Attempting dual isotopes:

```{r}
plot(raster("t2m_corr_gnip_next_02.gri"))
plot(coastsCoarse,add=TRUE)
```

```{r}
clim2 <- subset(clim, month == c(1,2))
clim2$year <- (clim2$year - 1)
clim3 <- rbind(clim2, subset(clim, month==12))
gs_precip <- clim3 %>% group_by(year) %>% summarise(precip = sum(precip))
```

```{r}
dual_isotopes <- data.frame(o18 = std_summary, c13 = c13_summary)
```

1986 to 1987 shows a sharp decrease in precipitation

```{r}
dual_isotopes[c(27:28),]
```


```{r}
plot(dual_isotopes[c(27:28),])
```
Should be a straight line to the right, suggests both a decrease in photosynthesis and stomatal conductance
Can't make sense of the change in photosynthesis, but a decrease in stomatal conductance from a wet year to a dry year makes sense

Compositing by wet/dry years: 

```{r}
slice_max(gs_precip, n=5, order_by = precip)
slice_min(gs_precip, n=5, order_by = precip)
```

```{r}
wet <- dual_isotopes[c(4,5,27,46,57),]
dry <- dual_isotopes[c(1,6,16,21,35),]
```

```{r}
apply(wet,2,mean)
apply(dry,2,mean)
```

If plotted, should be a near horizontal line from right to left, which suggests INCREASE in stomatal conductance and photosynthesis from wet to dry, which makes no sense.


```{r}
plot(std_summary, c13_summary)
```

```{r}
nov_sub <- subset(clim[25:722,], month == 1)
nov_sub$year <- (nov_sub$year - 1)
ondj_sub <- rbind(nov_sub, subset(clim[13:722,], month == c(10,11,12)))
ondj_mean <- ondj_sub %>% group_by(year) %>% summarise(rad = mean(rad, na.rm=TRUE), precip = sum(precip, na.rm=TRUE), temp = mean(temp, na.rm=TRUE), vpd = mean(vpd, na.rm=TRUE), vpd = mean(vpd, na.rm=TRUE), rh = mean(rh, na.rm=TRUE))
```


```{r}
dual_comp <- data.frame(o18 = std_summary, c13 = c13_summary, precip=ondj_mean$precip, rh = ondj_mean$rh, vpd=ondj_mean$vpd, temp=ondj_mean$temp)
```

```{r}
cor.test(dual_comp$o18, dual_comp$c13)
```

```{r}
lm_dual <- lm(c13~o18, data=dual_comp)
summary(lm_dual)
```


```{r}
png(filename="dualcomp.png", height=350, width=600)
ggplot(dual_comp, aes(x=o18, y=c13))+
  geom_point(aes(col=vpd))+
  scale_color_viridis()+
  geom_abline(intercept= lm_dual$coefficients[1], slope=lm_dual$coefficients[2], col="red")+
 labs(y= "KBP δ13C (‰)", x = "KBP δ18O (‰)")+
  labs(
         colour = "VPD"
        )
dev.off()
```




```{r}
ggplot(dual_comp, aes(x=o18, y=vpd))+
  geom_point(aes(col=vpd))+
 labs(y= "KBP δ13C", x = "KBP δ18O")+
  labs(
         colour = "VPD"
        )
```

```{r}
minRH <- dual_comp[dual_comp$rh < 54,]
minPre <- dual_comp[dual_comp$precip < 4,]
maxVPD <- dual_comp[dual_comp$vpd > 7,]
maxtemp <- dual_comp[dual_comp$temp > 13,]
```

```{r}
ggplot(maxtemp, aes(x=o18, y=c13))+
  geom_point(aes(col=temp))
```


```{r}
datRas <- brick("rasters/ERA5_precip.gri")
datC <- subset(datRas, 121:828)
sel_test <- names(datC)[substr(names(datC), 7, 8) %in% c("01","02")]
```


```{r}
datC <- subset(datRas, 123:830)
```


This subsets the whole brick for just the months you want. The product here can be split even further
```{r}
sel_y <- names(datC)[substr(names(datC), 7, 8) %in% c("01","02")] #Creates true/false field of rasters for that yr
#use that index to subset the raster brick
datY <- subset(datC, sel_y, value=T) #subsets the dataset of only those that are true
names(datY) <- sel_test # make this variable that is the names that I want for the layers


sel_x <- names(datC)[substr(names(datC), 7, 8) %in% c("09","10","11","12")] #Creates true/false field of rasters for that year
#use that index to subset the raster brick
datX <- subset(datC, sel_x, value=T) #subsets the dataset of only those that are true


s <- stack(datY, datX)
b <- brick(s)
writeRaster(b,"ERA_evap_seas")
```

```{r}
datRas <- brick("rasters/ERA5_precip.gri")
datC <- subset(datRas, 121:827)
sel_test <- names(datC)[substr(names(datC), 7, 8) %in% c("01","02","03")]
datC <- subset(datRas, 133:831)
```


```{r}
sel_y <- names(datC)[substr(names(datC), 7, 8) %in% c("01","02","03")] #Creates true/false field of rasters for that yr
#use that index to subset the raster brick
datY <- subset(datC, sel_y, value=T) #subsets the dataset of only those that are true
names(datY) <- sel_test 
```

```{r}
datY$
```









Run this if limiting to a smaller season:
```{r}
datX <- brick("ERA_evap_seas.gri")

sel_x <- names(datX)[substr(names(datX), 7, 8) %in% c("09","10","11")] #Creates true/false field of rasters for that year
#use that index to subset the raster brick
datC <- subset(datX, sel_x, value=T) #subsets the dataset of only those that are true
```







This suposedly turns your brick into annual (seasonal) averages. However it must be edited
```{r}
rasYrs <- as.character(1961:2018)
datC <- brick("ERA_precip_seas")
sel_y <- names(datC)[substr(names(datC), 2, 5) %in% "1960"]
datY <- subset(datC, sel_y, value=T)
s <- stackApply(datY, indices =  rep(1,nlayers(datY)), fun = "mean", na.rm = T)
for (year in rasYrs){ # rasYrs is c("1960","1961","1962"...)
sel_y <- names(datC)[substr(names(datC), 2, 5) %in% rasYrs] #Creates true/false field of rasters for that year
#use that index to subset the raster brick
datY <- subset(datC, sel_y, value=T) #subsets the dataset of only those that are true
mean <- stackApply(datY, indices =  rep(1,nlayers(datY)), fun = "mean", na.rm = T)
s <- stack(s, mean)
}
b <- brick(s)
writeRaster(b,"precip_sept_feb_mean")
```


Manual if tool doesn't work:
Must edit while using!!!

```{r}
datC <- brick(datY)
```



```{r}
sel_y <- names(datC)[substr(names(datC), 2, 5) %in% "2010"]
datY <- subset(datC, sel_y, value=T)
s0 <- stackApply(datY, indices =  rep(1,nlayers(datY)), fun = "mean", na.rm = T)
names(s0) <- "X2010"
sel_y <- names(datC)[substr(names(datC), 2, 5) %in% "2011"]
datY <- subset(datC, sel_y, value=T)
s1 <- stackApply(datY, indices =  rep(1,nlayers(datY)), fun = "mean", na.rm = T)
names(s1) <- "X2011"
sel_y <- names(datC)[substr(names(datC), 2, 5) %in% "2012"]
datY <- subset(datC, sel_y, value=T)
s2 <- stackApply(datY, indices =  rep(1,nlayers(datY)), fun = "mean", na.rm = T)
names(s2) <- "X2012"
sel_y <- names(datC)[substr(names(datC), 2, 5) %in% "2013"]
datY <- subset(datC, sel_y, value=T)
s3 <- stackApply(datY, indices =  rep(1,nlayers(datY)), fun = "mean", na.rm = T)
names(s3) <- "X2013"
sel_y <- names(datC)[substr(names(datC), 2, 5) %in% "2014"]
datY <- subset(datC, sel_y, value=T)
s4 <- stackApply(datY, indices =  rep(1,nlayers(datY)), fun = "mean", na.rm = T)
names(s4) <- "X2014"
sel_y <- names(datC)[substr(names(datC), 2, 5) %in% "2015"]
datY <- subset(datC, sel_y, value=T)
s5 <- stackApply(datY, indices =  rep(1,nlayers(datY)), fun = "mean", na.rm = T)
names(s5) <- "X2015"
sel_y <- names(datC)[substr(names(datC), 2, 5) %in% "2016"]
datY <- subset(datC, sel_y, value=T)
s6 <- stackApply(datY, indices =  rep(1,nlayers(datY)), fun = "mean", na.rm = T)
names(s6) <- "X2016"
sel_y <- names(datC)[substr(names(datC), 2, 5) %in% "2017"]
datY <- subset(datC, sel_y, value=T)
s7 <- stackApply(datY, indices =  rep(1,nlayers(datY)), fun = "mean", na.rm = T)
names(s7) <- "X2017"
sel_y <- names(datC)[substr(names(datC), 2, 5) %in% "2018"]
datY <- subset(datC, sel_y, value=T)
s8 <- stackApply(datY, indices =  rep(1,nlayers(datY)), fun = "mean", na.rm = T)
names(s8) <- "X2018"


s <- stack(s,s0,s1,s2,s3,s4,s5,s6,s7,s8)
```
sel_y <- names(datC)[substr(names(datC), 2, 5) %in% "2019"]
datY <- subset(datC, sel_y, value=T)
s9 <- stackApply(datY, indices =  rep(1,nlayers(datY)), fun = "mean", na.rm = T)
names(s9) <- "X2019"
```{r}
s$
```



```{r}
b <- brick(s)
writeRaster(b,"precip_jan_mar_mean")
```



```{r}
mtrd <-	cbind(-41.84, 145.53)
mrd_points <- SpatialPoints(coords = mtrd, proj4string = crs("+proj=longlat +datum=WGS84 +no_defs"))

xy <- raster::extract(brick, cbind(145.53, -41.84), method="bilinear", df=TRUE)
```

```{r}
precippts <- t(xy[-1])
```


```{r}
plot(precippts, std_summary, main="ERA5 vs. 18O")
cor.test(precippts, std_summary)
```

```{r}
plot(precippts, jfm_mean$precip, main = "ERA5 vs. SILO")
cor.test(precippts, jfm_mean$precip)
```

```{r}
plot(jfm_mean$precip, std_summary, main = "SILO vs. 18O")
cor.test(jfm_mean$precip, std_summary)
```



Correlate:

```{r}
datY <- brick("evap_sep_nov_mean.gri")
ar.datY <- as.array(datY)

z <- apply(ar.datY, 1:2, rcorr, std_summary, type="pearson")
corr = array(0, dim=c(360,720) )
sig = array(0, dim=c(360,720) )
for (x in 1:259200)
{
corr[x] <- z[[x]][[1]][2]
sig[x] <- z[[x]][[3]][2]
}

l <- list(corr, sig)
a <- do.call(rbind, l)
library(abind)
a <- abind(l, along=3)

r <- brick(a, xmn=0.125, xmx=180.125, ymn=-89.875, ymx=0.125, crs=CRS("+proj=longlat +datum=WGS84"))
writeRaster(r, paste0("evap_corr_sep_nov"))
```

```{r}
resbrick <- brick("evap_corr_sep_nov.gri")
```

```{r}
plot(resbrick$layer.1)
```



```{r}
world_shp <- read_sf("coasts/ne_10m_coastline.shp")
world_outline <- as(st_geometry(world_shp), Class="Spatial")
```

```{r}
full <- brick("rasters/results/seasonal/precip_corr_sep_feb.gri")
sepnov <- brick("rasters/results/seasonal/precip_corr_sep_nov.gri")
octdec <- brick("rasters/results/seasonal/precip_corr_oct_dec.gri")
novjan <- brick("rasters/results/seasonal/precip_corr_nov_jan.gri")
decfeb <- brick("rasters/results/seasonal/precip_corr_dec_feb.gri")
```

```{r}
e <- extent(110, 160, -50, -20)
cropped <- crop(decfeb, e)	
corrRas <- cropped$layer.1
sigRas <- cropped$layer.2
sigRas[sigRas > 0.05] <- NA #mask out insignificant values
sigRas[sigRas == 0] <- NA
masked <- raster::mask(corrRas, sigRas)
```

```{r}
masked
```


```{r}
colr <- colorRampPalette(brewer.pal(9, 'RdBu'))
levelplot(masked, margin=FALSE, xlab="Longitude", ylab="Latitude", main="Precipitation ~ d18O", pretty=FALSE, col.regions=colr, at=seq(-0.6, 0.6, 0.1))+
  latticeExtra::layer(sp.lines(world_outline))
```





```{r}
mean(as.matrix(new_c13[,-4]), na.rm=TRUE)
```


```{r}
sd_C <- apply(new_c13[,-4], 1, sd, na.rm=T)
mean(sd_C)
```


```{r}
citation("splitr")
```


```{r}
rwl.stats(tab)
```

```{r}
rwl.report(tab)
```

```{r}
rwl.report(new_c13[,-4])
```

```{r}
rwi.stats(tab)
```

```{r}
mean(glk(tab)$glk_mat, na.rm=TRUE)
```

```{r}
rwi.stats.running(tab, window.length=10)
```

```{r}
MRDmaster <- read.rwl("FullMasterSN.txt")
```

```{r}
MRD_std <- scale(MRDmaster)
MRD_dfstd<- as.data.frame(MRD_std)
detrended_MRD <- detrend(MRD_dfstd, method="Spline")
```


```{r}
ci3 <- as.data.frame(t(apply(MRD_dfstd[2400:2458,], 1, ci.func)))
ci3$med <- as.numeric("")
ci3$med <- trimMRD$mrdstd
ci3$year <- rownames(ci3)
```

```{r}
ci3
```


```{r}
lm_rwd<- lm(med~year, data=ci3)
```

```{r}
ci3
```


```{r}
p<-ggplot(data=ci3, aes(x=year, group=1)) +
  geom_ribbon(aes(ymin=lower, ymax=upper, fill="95% confidence interval of median ring width"), linetype=2, alpha=0.3)+
  geom_line(aes(y=med),size=2, col="darkslategrey")+
  geom_abline(intercept= lm_rwd$coefficients[1], slope=lm_rwd$coefficients[2], col="red")+
  labs(y= "KBP Ring Width", x = "Year")+
  scale_x_continuous(breaks=seq(1960,2020,10))+
  scale_fill_manual("",values="darkgreen")+
  theme(
    legend.position = c(.95, .05),
    legend.justification = c("right", "bottom"),
    legend.box.just = "right",
    legend.margin = margin(0,5,5, 5)
    )+
  scale_linetype(name = NULL)

p

```

END HERE!




